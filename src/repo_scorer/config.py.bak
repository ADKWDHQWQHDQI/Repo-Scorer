"""Configuration for DevOps pipeline assessment questions and scoring"""

from enum import Enum
from typing import Dict, List, Tuple
from dataclasses import dataclass


# Single unified repository tool enum
class RepositoryTool(str, Enum):
    """Supported DevOps platforms"""
    GITHUB = "github"
    GITLAB = "gitlab"
    AZURE_DEVOPS = "azure_devops"
    JENKINS = "jenkins"
    BITBUCKET = "bitbucket"


@dataclass
class Question:
    """Individual question with scoring"""
    id: str
    text: str
    max_score: float  # Normalized to ensure total = 100
    importance: float  # Importance weight (1-10 scale)
    pillar: str


@dataclass
class Pillar:
    """Scoring pillar with questions"""
    name: str
    total_weight: float
    questions: List[Question]


# ============================================================================
# PLATFORM QUESTIONS (5 questions per platform = 15 total)
# ============================================================================

# GitHub - 5 questions
GITHUB_QUESTIONS = [
    ("Do you use branch protection rules with required pull request reviews?", 10.0, "Code Review"),
    ("Is GitHub secret scanning enabled to prevent credential leaks?", 10.0, "Security"),
    ("Do you use Dependabot for automated dependency updates?", 8.0, "Security"),
    ("Is repository access managed through organizations and teams?", 8.0, "Access Control"),
    ("Are pull request templates standardized across repositories?", 5.0, "Standards"),
]

# GitLab - 5 questions
GITLAB_QUESTIONS = [
    ("Are merge request approval rules configured?", 9.0, "Code Review"),
    ("Do you use Code Owners for automated reviewer assignment?", 7.0, "code_review"),
    ("Are merge request templates standardized across projects?", 5.0, "code_review"),
    ("Is merge request pipeline success required before merging?", 9.0, "code_review"),
    ("Are protected branches configured with restricted push/merge permissions?", 10.0, "repo_security"),
    ("Do you use push rules to prevent secrets and large files?", 10.0, "repo_security"),
    ("Is commit signing enabled and enforced?", 6.0, "repo_security"),
    ("Are dependency and container scanning integrated into MRs?", 8.0, "repo_security"),
    ("Is repository access managed through groups and subgroups?", 8.0, "access_governance"),
    ("Are project access levels (Guest, Reporter, Developer, Maintainer) properly governed?", 7.0, "access_governance"),
    ("Do you use Protected branches to control merge and push access?", 10.0, "access_governance"),
    ("Are deploy keys and tokens regularly audited and rotated?", 6.0, "access_governance"),
    ("Is repository organization aligned with groups/subgroups structure?", 4.0, "repo_organization"),
    ("Are inactive merge requests automatically closed or flagged?", 3.0, "repo_organization"),
    ("Do you have a documented repository strategy (monorepo/multirepo)?", 5.0, "repo_organization"),
    ("Is your branching workflow documented (GitLab Flow, trunk-based)?", 7.0, "source_control"),
    ("Are merge strategies standardized (merge commit, squash, fast-forward)?", 5.0, "source_control"),
    ("Do you enforce commit message conventions?", 4.0, "source_control"),
]

# Azure Repos Questions
AZURE_REPOS_QUESTIONS = [
    ("Are branch policies enforced with minimum reviewers and build validation?", 10.0, "code_review"),
    ("Do you use path-based policies for critical code areas?", 8.0, "code_review"),
    ("Are pull request templates standardized across repositories?", 5.0, "code_review"),
    ("Is comment resolution required before PR completion?", 7.0, "code_review"),
    ("Are branch policies used to enforce security scans before merge?", 9.0, "repo_security"),
    ("Do you use service hooks to prevent secret commits?", 10.0, "repo_security"),
    ("Are repository permissions managed through Azure AD groups?", 8.0, "repo_security"),
    ("Is Advanced Security enabled for secret and dependency scanning?", 8.0, "repo_security"),
    ("Are repository permissions aligned with Azure AD and team structure?", 8.0, "access_governance"),
    ("Are naming conventions enforced for repositories and branches?", 3.0, "access_governance"),
    ("Do you use permission inheritance from project to repository level?", 6.0, "access_governance"),
    ("Are service connections and PATs regularly audited?", 7.0, "access_governance"),
    ("Is repository structure aligned with Azure DevOps project organization?", 4.0, "repo_organization"),
    ("Are completed PR branches automatically deleted?", 3.0, "repo_organization"),
    ("Do you have a defined strategy for monorepo vs microservices repos?", 5.0, "repo_organization"),
    ("Is your branching strategy documented (release branches, trunk-based)?", 7.0, "source_control"),
    ("Are merge strategies consistent (squash, rebase, merge commit)?", 5.0, "source_control"),
    ("Do you maintain a clean commit history with meaningful messages?", 4.0, "source_control"),
]

# Bitbucket Repository Questions
BITBUCKET_REPO_QUESTIONS = [
    ("Are branch permissions configured to protect critical branches?", 10.0, "code_review"),
    ("Do you use default reviewers and automatic PR assignment?", 7.0, "code_review"),
    ("Are merge checks enforced (build success, task completion)?", 9.0, "code_review"),
    ("Are pull request templates used for consistency?", 5.0, "code_review"),
    ("Are branch permissions used to prevent direct pushes to main?", 10.0, "repo_security"),
    ("Do you use merge checks to prevent commits with secrets?", 9.0, "repo_security"),
    ("Is two-factor authentication enforced for all users?", 8.0, "repo_security"),
    ("Are access keys and SSH keys regularly reviewed?", 6.0, "repo_security"),
    ("Are repository permissions managed through groups and project roles?", 8.0, "access_governance"),
    ("Is workspace access clearly separated from project access?", 7.0, "access_governance"),
    ("Do you use project permissions to manage multiple repositories?", 6.0, "access_governance"),
    ("Are app passwords and OAuth tokens regularly audited?", 6.0, "access_governance"),
    ("Is repository organization consistent across workspaces?", 4.0, "repo_organization"),
    ("Are merged branches automatically cleaned up?", 3.0, "repo_organization"),
    ("Do you have a clear repository structure strategy?", 5.0, "repo_organization"),
    ("Is your branching model documented (Git Flow, trunk-based)?", 7.0, "source_control"),
    ("Are merge strategies clearly defined and followed?", 5.0, "source_control"),
    ("Do you enforce commit message standards?", 4.0, "source_control"),
]

# ============================================================================
# CI/CD PLATFORM QUESTIONS
# ============================================================================
# Pillars: pipeline_security, build_automation, artifact_management, deployment_gates, pipeline_monitoring

# GitHub Actions Questions
GITHUB_ACTIONS_QUESTIONS = [
    ("Are workflow permissions restricted using least-privilege access?", 10.0, "pipeline_security"),
    ("Do you use OpenID Connect (OIDC) instead of long-lived secrets for cloud access?", 9.0, "pipeline_security"),
    ("Are secrets managed using GitHub encrypted secrets or external vaults?", 10.0, "pipeline_security"),
    ("Are third-party actions pinned to specific commit SHAs?", 8.0, "pipeline_security"),
    ("Are workflows protected with required status checks?", 9.0, "pipeline_security"),
    ("Are CI builds triggered automatically on every pull request?", 9.0, "build_automation"),
    ("Do you run automated tests (unit, integration) in workflows?", 10.0, "build_automation"),
    ("Are code quality checks (linting, formatting) automated?", 7.0, "build_automation"),
    ("Do you use matrix builds to test across multiple environments?", 6.0, "build_automation"),
    ("Are build caches used to optimize workflow execution time?", 5.0, "build_automation"),
    ("Are build artifacts stored and versioned in GitHub Packages or Artifacts?", 8.0, "artifact_management"),
    ("Do you use semantic versioning for release artifacts?", 7.0, "artifact_management"),
    ("Are container images scanned for vulnerabilities before publishing?", 9.0, "artifact_management"),
    ("Are artifacts retained with appropriate retention policies?", 5.0, "artifact_management"),
    ("Are deployments protected with environment protection rules?", 9.0, "deployment_gates"),
    ("Do you use manual approval gates for production deployments?", 8.0, "deployment_gates"),
    ("Are deployment branches restricted for critical environments?", 7.0, "deployment_gates"),
    ("Are workflow runs monitored and alerted on failures?", 7.0, "pipeline_monitoring"),
    ("Do you track workflow execution time and optimize slow pipelines?", 4.0, "pipeline_monitoring"),
    ("Are workflow logs retained for audit and debugging purposes?", 6.0, "pipeline_monitoring"),
]

# Azure Pipelines Questions
AZURE_PIPELINES_QUESTIONS = [
    ("Are service connections secured with least-privilege permissions?", 10.0, "pipeline_security"),
    ("Do you use Workload Identity Federation for Azure deployments?", 9.0, "pipeline_security"),
    ("Are pipeline secrets managed using Azure Key Vault?", 10.0, "pipeline_security"),
    ("Are variable groups restricted to specific pipelines and environments?", 8.0, "pipeline_security"),
    ("Are pipeline permissions managed through Azure AD security groups?", 8.0, "pipeline_security"),
    ("Are CI pipelines triggered automatically on PRs and main branch?", 9.0, "build_automation"),
    ("Do you run comprehensive test suites (unit, integration, E2E)?", 10.0, "build_automation"),
    ("Are code coverage and quality gates enforced?", 8.0, "build_automation"),
    ("Do you use multi-stage pipelines for build, test, and deploy?", 7.0, "build_automation"),
    ("Are pipeline templates used for consistency across projects?", 6.0, "build_automation"),
    ("Are build artifacts published to Azure Artifacts or container registries?", 8.0, "artifact_management"),
    ("Do you use retention policies for artifacts and pipeline runs?", 5.0, "artifact_management"),
    ("Are artifacts versioned using semantic versioning or build numbers?", 7.0, "artifact_management"),
    ("Are container images and packages scanned for vulnerabilities?", 9.0, "artifact_management"),
    ("Are deployment approvals configured for production environments?", 9.0, "deployment_gates"),
    ("Do you use pre-deployment and post-deployment gates?", 8.0, "deployment_gates"),
    ("Are deployment conditions based on branch policies and checks?", 7.0, "deployment_gates"),
    ("Are pipeline runs monitored with alerts for failures?", 7.0, "pipeline_monitoring"),
    ("Do you track pipeline performance metrics (duration, success rate)?", 5.0, "pipeline_monitoring"),
    ("Are pipeline logs integrated with Azure Monitor for analysis?", 6.0, "pipeline_monitoring"),
]

# GitLab CI Questions
GITLAB_CI_QUESTIONS = [
    ("Are CI/CD variables protected and masked for sensitive values?", 10.0, "pipeline_security"),
    ("Do you use OIDC tokens for cloud provider authentication?", 9.0, "pipeline_security"),
    ("Are secrets managed using GitLab CI/CD variables or external vaults?", 10.0, "pipeline_security"),
    ("Are pipeline permissions restricted using protected branches and tags?", 8.0, "pipeline_security"),
    ("Are runner tokens secured and regularly rotated?", 7.0, "pipeline_security"),
    ("Are pipelines automatically triggered on merge requests?", 9.0, "build_automation"),
    ("Do you run automated test suites in pipeline stages?", 10.0, "build_automation"),
    ("Are code quality and security scans integrated into pipelines?", 8.0, "build_automation"),
    ("Do you use DAG pipelines for parallel execution optimization?", 6.0, "build_automation"),
    ("Are pipeline templates (includes/extends) used for reusability?", 6.0, "build_automation"),
    ("Are build artifacts and reports stored in GitLab?", 7.0, "artifact_management"),
    ("Do you use GitLab Container Registry for image storage?", 8.0, "artifact_management"),
    ("Are artifacts versioned using tags or semantic versioning?", 7.0, "artifact_management"),
    ("Are container images scanned using GitLab Container Scanning?", 9.0, "artifact_management"),
    ("Are deployments protected with environment-specific approvals?", 9.0, "deployment_gates"),
    ("Do you use deployment approvals for production environments?", 8.0, "deployment_gates"),
    ("Are deployment policies configured to restrict who can deploy?", 7.0, "deployment_gates"),
    ("Are pipeline failures monitored and alerted?", 7.0, "pipeline_monitoring"),
    ("Do you track pipeline duration and success rates?", 5.0, "pipeline_monitoring"),
    ("Are pipeline metrics visible in dashboards for team review?", 5.0, "pipeline_monitoring"),
]

# Jenkins Questions
JENKINS_QUESTIONS = [
    ("Are Jenkins credentials stored in Credentials Plugin with encryption?", 10.0, "pipeline_security"),
    ("Is Jenkins secured with authentication and authorization (RBAC)?", 10.0, "pipeline_security"),
    ("Are plugins regularly updated and audited for vulnerabilities?", 8.0, "pipeline_security"),
    ("Are build agents isolated and secured (no admin access)?", 9.0, "pipeline_security"),
    ("Are Jenkinsfiles stored in version control (Pipeline as Code)?", 8.0, "pipeline_security"),
    ("Are builds triggered automatically via webhooks or polling?", 8.0, "build_automation"),
    ("Do you run automated test suites in Jenkins pipelines?", 10.0, "build_automation"),
    ("Are declarative or scripted pipelines used for consistency?", 7.0, "build_automation"),
    ("Do you use parallel stages to optimize build times?", 6.0, "build_automation"),
    ("Are shared libraries used for pipeline code reusability?", 6.0, "build_automation"),
    ("Are build artifacts archived and versioned in Jenkins?", 7.0, "artifact_management"),
    ("Do you integrate with Artifactory or Nexus for artifact storage?", 8.0, "artifact_management"),
    ("Are artifacts published with semantic versioning or build numbers?", 7.0, "artifact_management"),
    ("Are artifacts scanned for vulnerabilities before release?", 8.0, "artifact_management"),
    ("Are deployments gated with manual approval steps?", 8.0, "deployment_gates"),
    ("Do you use input steps for production deployment approvals?", 7.0, "deployment_gates"),
    ("Are deployment permissions restricted to specific users/roles?", 8.0, "deployment_gates"),
    ("Are build failures monitored and alerted via email/Slack?", 7.0, "pipeline_monitoring"),
    ("Do you track build duration and success rate metrics?", 5.0, "pipeline_monitoring"),
    ("Are build logs retained for debugging and audit purposes?", 6.0, "pipeline_monitoring"),
]

# CircleCI Questions
CIRCLECI_QUESTIONS = [
    ("Are contexts used to manage secrets with restricted access?", 10.0, "pipeline_security"),
    ("Are OIDC tokens used for cloud provider authentication?", 9.0, "pipeline_security"),
    ("Are orbs from trusted sources only (certified/partner orbs)?", 7.0, "pipeline_security"),
    ("Are environment variables encrypted and scoped to projects?", 9.0, "pipeline_security"),
    ("Are pipeline permissions managed using contexts and project settings?", 8.0, "pipeline_security"),
    ("Are workflows triggered automatically on every commit/PR?", 9.0, "build_automation"),
    ("Do you run automated tests in parallel for faster feedback?", 9.0, "build_automation"),
    ("Are test results and code coverage published?", 7.0, "build_automation"),
    ("Do you use workflows to orchestrate complex build processes?", 7.0, "build_automation"),
    ("Are Docker layer caching and dependency caching enabled?", 6.0, "build_automation"),
    ("Are artifacts stored using CircleCI artifact storage?", 7.0, "artifact_management"),
    ("Do you publish artifacts to external registries (Docker Hub, ECR)?", 8.0, "artifact_management"),
    ("Are artifacts versioned using tags or semantic versioning?", 7.0, "artifact_management"),
    ("Are container images scanned for security vulnerabilities?", 8.0, "artifact_management"),
    ("Are deployments protected with approval jobs?", 8.0, "deployment_gates"),
    ("Do you use hold jobs for manual production deployment approval?", 8.0, "deployment_gates"),
    ("Are deployment workflows restricted to specific branches?", 7.0, "deployment_gates"),
    ("Are workflow failures monitored with Slack/email notifications?", 7.0, "pipeline_monitoring"),
    ("Do you track workflow performance insights and optimize?", 5.0, "pipeline_monitoring"),
    ("Are test results integrated with Insights for trend analysis?", 5.0, "pipeline_monitoring"),
]

# ============================================================================
# DEPLOYMENT PLATFORM QUESTIONS
# ============================================================================
# Pillars: infrastructure_code, environment_management, deployment_security, monitoring_observability, resilience

# Azure Deployment Questions
AZURE_DEPLOYMENT_QUESTIONS = [
    ("Are all infrastructure resources defined as code (ARM, Bicep, Terraform)?", 10.0, "infrastructure_code"),
    ("Are IaC templates version-controlled and peer-reviewed?", 9.0, "infrastructure_code"),
    ("Do you use Azure Resource Manager deployment validation before apply?", 7.0, "infrastructure_code"),
    ("Are resource naming conventions automated through IaC?", 5.0, "infrastructure_code"),
    ("Are IaC state files secured (Azure Storage with encryption)?", 8.0, "infrastructure_code"),
    ("Are deployment slots used for staging and blue-green deployments?", 8.0, "environment_management"),
    ("Do you maintain environment parity (dev, staging, production)?", 9.0, "environment_management"),
    ("Are environment-specific configurations managed separately (App Config, Key Vault)?", 9.0, "environment_management"),
    ("Are deployments automated with zero-downtime strategies?", 8.0, "environment_management"),
    ("Are resource tags used consistently for environment identification?", 5.0, "environment_management"),
    ("Are Azure Key Vault and Managed Identities used for secrets?", 10.0, "deployment_security"),
    ("Is Azure RBAC configured with least-privilege access?", 10.0, "deployment_security"),
    ("Are network security groups and private endpoints configured?", 9.0, "deployment_security"),
    ("Is Microsoft Defender for Cloud enabled for security monitoring?", 8.0, "deployment_security"),
    ("Are compliance policies enforced using Azure Policy?", 8.0, "deployment_security"),
    ("Are Application Insights enabled for application monitoring?", 9.0, "monitoring_observability"),
    ("Do you use Azure Monitor for infrastructure and platform monitoring?", 9.0, "monitoring_observability"),
    ("Are alerts configured for critical application and infrastructure metrics?", 9.0, "monitoring_observability"),
    ("Are logs centralized in Log Analytics Workspace?", 8.0, "monitoring_observability"),
    ("Do you have dashboards for real-time operational visibility?", 6.0, "monitoring_observability"),
    ("Are automated backups configured for critical data and services?", 10.0, "resilience"),
    ("Do you have documented disaster recovery procedures?", 9.0, "resilience"),
    ("Are availability zones or region pairs used for high availability?", 9.0, "resilience"),
    ("Are rollback procedures tested and documented?", 8.0, "resilience"),
    ("Is health monitoring configured to detect and recover from failures?", 8.0, "resilience"),
]

# AWS Deployment Questions
AWS_DEPLOYMENT_QUESTIONS = [
    ("Are all infrastructure resources defined as code (CloudFormation, Terraform)?", 10.0, "infrastructure_code"),
    ("Are IaC templates version-controlled and reviewed?", 9.0, "infrastructure_code"),
    ("Do you use CloudFormation ChangeSet previews before deployment?", 7.0, "infrastructure_code"),
    ("Are resource naming and tagging standardized through IaC?", 5.0, "infrastructure_code"),
    ("Are Terraform state files secured (S3 with encryption and versioning)?", 8.0, "infrastructure_code"),
    ("Do you use blue-green or canary deployment strategies?", 8.0, "environment_management"),
    ("Are multiple environments (dev, staging, prod) isolated in separate accounts?", 9.0, "environment_management"),
    ("Are environment configurations managed using Parameter Store or Secrets Manager?", 9.0, "environment_management"),
    ("Are deployments automated with zero-downtime strategies (ELB, rolling updates)?", 8.0, "environment_management"),
    ("Are resource tags used for environment tracking and cost allocation?", 6.0, "environment_management"),
    ("Are AWS Secrets Manager and IAM roles used instead of access keys?", 10.0, "deployment_security"),
    ("Is IAM configured with least-privilege policies and SCPs?", 10.0, "deployment_security"),
    ("Are security groups and NACLs properly configured?", 9.0, "deployment_security"),
    ("Is AWS Security Hub enabled for compliance and security monitoring?", 8.0, "deployment_security"),
    ("Are AWS Config rules enforced for compliance policies?", 8.0, "deployment_security"),
    ("Is CloudWatch monitoring enabled for applications and infrastructure?", 9.0, "monitoring_observability"),
    ("Are X-Ray or CloudWatch Insights used for distributed tracing?", 7.0, "monitoring_observability"),
    ("Are CloudWatch alarms configured for critical metrics?", 9.0, "monitoring_observability"),
    ("Are logs centralized in CloudWatch Logs or S3?", 8.0, "monitoring_observability"),
    ("Do you have CloudWatch dashboards for operational visibility?", 6.0, "monitoring_observability"),
    ("Are automated backups configured for RDS, DynamoDB, and EBS?", 10.0, "resilience"),
    ("Do you have documented disaster recovery runbooks?", 9.0, "resilience"),
    ("Are multi-AZ deployments used for high availability?", 9.0, "resilience"),
    ("Are rollback procedures automated and tested?", 8.0, "resilience"),
    ("Is Route 53 health checking configured for automatic failover?", 8.0, "resilience"),
]

# GCP Deployment Questions
GCP_DEPLOYMENT_QUESTIONS = [
    ("Are all infrastructure resources defined as code (Deployment Manager, Terraform)?", 10.0, "infrastructure_code"),
    ("Are IaC templates version-controlled and peer-reviewed?", 9.0, "infrastructure_code"),
    ("Do you use gcloud preview or Terraform plan before applying changes?", 7.0, "infrastructure_code"),
    ("Are resource naming conventions enforced through IaC?", 5.0, "infrastructure_code"),
    ("Are Terraform state files secured (GCS with encryption)?", 8.0, "infrastructure_code"),
    ("Do you use traffic splitting for canary or blue-green deployments?", 8.0, "environment_management"),
    ("Are environments isolated using separate GCP projects?", 9.0, "environment_management"),
    ("Are configurations managed using Secret Manager or Config Connector?", 9.0, "environment_management"),
    ("Are deployments automated with rolling updates or blue-green strategies?", 8.0, "environment_management"),
    ("Are labels used consistently for environment and cost tracking?", 6.0, "environment_management"),
    ("Are Secret Manager and Workload Identity used instead of service account keys?", 10.0, "deployment_security"),
    ("Is IAM configured with least-privilege and organization policies?", 10.0, "deployment_security"),
    ("Are VPC firewalls and Private Google Access configured?", 9.0, "deployment_security"),
    ("Is Security Command Center enabled for threat detection?", 8.0, "deployment_security"),
    ("Are organization policies enforced for compliance?", 8.0, "deployment_security"),
    ("Is Cloud Monitoring (formerly Stackdriver) enabled?", 9.0, "monitoring_observability"),
    ("Are Cloud Trace and Profiler used for application performance monitoring?", 7.0, "monitoring_observability"),
    ("Are alerting policies configured for critical metrics?", 9.0, "monitoring_observability"),
    ("Are logs centralized in Cloud Logging?", 8.0, "monitoring_observability"),
    ("Do you have Cloud Monitoring dashboards for operational insights?", 6.0, "monitoring_observability"),
    ("Are automated backups configured for Cloud SQL and persistent disks?", 10.0, "resilience"),
    ("Do you have documented disaster recovery plans?", 9.0, "resilience"),
    ("Are multi-zone or multi-region deployments configured?", 9.0, "resilience"),
    ("Are rollback procedures documented and tested?", 8.0, "resilience"),
    ("Is health checking configured with automatic recovery?", 8.0, "resilience"),
]

# On-Premise Deployment Questions
ON_PREMISE_DEPLOYMENT_QUESTIONS = [
    ("Are infrastructure configurations managed as code (Ansible, Puppet, Terraform)?", 9.0, "infrastructure_code"),
    ("Are configuration files version-controlled?", 9.0, "infrastructure_code"),
    ("Do you use configuration management tools for consistent deployments?", 8.0, "infrastructure_code"),
    ("Are server provisioning and configuration automated?", 8.0, "infrastructure_code"),
    ("Are infrastructure changes peer-reviewed before execution?", 7.0, "infrastructure_code"),
    ("Are separate environments (dev, staging, prod) properly isolated?", 9.0, "environment_management"),
    ("Are environment configurations externalized and managed separately?", 8.0, "environment_management"),
    ("Are deployments automated with rollback capabilities?", 8.0, "environment_management"),
    ("Do you use load balancers for zero-downtime deployments?", 7.0, "environment_management"),
    ("Are environment inventories documented and maintained?", 6.0, "environment_management"),
    ("Are secrets managed using vaults (HashiCorp Vault, CyberArk)?", 10.0, "deployment_security"),
    ("Is access control enforced using RBAC and network segmentation?", 10.0, "deployment_security"),
    ("Are firewalls and network policies properly configured?", 9.0, "deployment_security"),
    ("Are security patches applied regularly and systematically?", 9.0, "deployment_security"),
    ("Are vulnerability scans performed on servers and applications?", 8.0, "deployment_security"),
    ("Are application and infrastructure metrics collected and monitored?", 8.0, "monitoring_observability"),
    ("Do you use centralized logging (ELK, Splunk, Graylog)?", 9.0, "monitoring_observability"),
    ("Are alerts configured for critical system and application events?", 9.0, "monitoring_observability"),
    ("Are monitoring dashboards available for operations teams?", 7.0, "monitoring_observability"),
    ("Are logs retained for compliance and troubleshooting?", 7.0, "monitoring_observability"),
    ("Are automated backups performed and tested regularly?", 10.0, "resilience"),
    ("Do you have documented disaster recovery procedures?", 9.0, "resilience"),
    ("Is high availability configured across multiple nodes or data centers?", 9.0, "resilience"),
    ("Are failover procedures automated and tested?", 8.0, "resilience"),
    ("Are backup restoration procedures regularly tested?", 9.0, "resilience"),
]

# Kubernetes Deployment Questions
KUBERNETES_DEPLOYMENT_QUESTIONS = [
    ("Are all Kubernetes resources defined as code (YAML, Helm, Kustomize)?", 10.0, "infrastructure_code"),
    ("Are manifests version-controlled and peer-reviewed?", 9.0, "infrastructure_code"),
    ("Do you use GitOps practices (ArgoCD, Flux) for deployments?", 8.0, "infrastructure_code"),
    ("Are Helm charts or Kustomize overlays used for environment management?", 7.0, "infrastructure_code"),
    ("Are resource requests and limits defined for all workloads?", 8.0, "infrastructure_code"),
    ("Are namespaces used to isolate different environments?", 9.0, "environment_management"),
    ("Are environment-specific configurations managed using ConfigMaps and Secrets?", 9.0, "environment_management"),
    ("Are rolling updates and readiness probes configured for zero-downtime?", 9.0, "environment_management"),
    ("Do you use canary or blue-green deployment strategies?", 7.0, "environment_management"),
    ("Are resource quotas and limit ranges configured per namespace?", 6.0, "environment_management"),
    ("Are secrets encrypted at rest using KMS or external secrets managers?", 10.0, "deployment_security"),
    ("Is RBAC configured with least-privilege access for service accounts?", 10.0, "deployment_security"),
    ("Are network policies configured to restrict pod-to-pod traffic?", 9.0, "deployment_security"),
    ("Are pod security policies or Pod Security Standards enforced?", 9.0, "deployment_security"),
    ("Are container images scanned for vulnerabilities before deployment?", 9.0, "deployment_security"),
    ("Are Prometheus and Grafana (or equivalent) used for monitoring?", 9.0, "monitoring_observability"),
    ("Are application metrics exposed and scraped by monitoring tools?", 8.0, "monitoring_observability"),
    ("Are alerts configured for cluster and application health?", 9.0, "monitoring_observability"),
    ("Are logs centralized using Fluentd, Loki, or cloud-native solutions?", 8.0, "monitoring_observability"),
    ("Do you have dashboards for cluster and application visibility?", 7.0, "monitoring_observability"),
    ("Are persistent volumes backed up regularly?", 9.0, "resilience"),
    ("Do you have documented disaster recovery procedures for the cluster?", 9.0, "resilience"),
    ("Are workloads distributed across multiple nodes/zones for HA?", 9.0, "resilience"),
    ("Are HorizontalPodAutoscalers configured for scaling under load?", 7.0, "resilience"),
    ("Are PodDisruptionBudgets configured to maintain availability during disruptions?", 8.0, "resilience"),
]


# Pillar metadata by category
REPOSITORY_PILLAR_METADATA = {
    "source_control": {
        "name": "Source Control & Branching",
        "description": "Branching strategies, merge policies, and version control practices"
    },
    "code_review": {
        "name": "Code Review & Quality Gates",
        "description": "Pull request processes, approval workflows, and review standards"
    },
    "repo_security": {
        "name": "Repository Security",
        "description": "Secret scanning, vulnerability detection, and secure code practices"
    },
    "access_governance": {
        "name": "Access Control & Governance",
        "description": "Permissions, authentication, and access management"
    },
    "repo_organization": {
        "name": "Repository Organization",
        "description": "Structure, naming conventions, and repository management"
    }
}

CICD_PILLAR_METADATA = {
    "pipeline_security": {
        "name": "Pipeline Security & Compliance",
        "description": "Secrets management, permissions, and secure CI/CD practices"
    },
    "build_automation": {
        "name": "Build & Test Automation",
        "description": "Automated testing, code quality checks, and build processes"
    },
    "artifact_management": {
        "name": "Artifact Management",
        "description": "Artifact storage, versioning, and vulnerability scanning"
    },
    "deployment_gates": {
        "name": "Deployment Gates & Approvals",
        "description": "Approval workflows, deployment restrictions, and release controls"
    },
    "pipeline_monitoring": {
        "name": "Pipeline Monitoring & Reliability",
        "description": "Build monitoring, performance tracking, and failure alerts"
    }
}

DEPLOYMENT_PILLAR_METADATA = {
    "infrastructure_code": {
        "name": "Infrastructure as Code",
        "description": "IaC practices, version control, and automated provisioning"
    },
    "environment_management": {
        "name": "Environment Management",
        "description": "Environment isolation, configuration management, and deployment strategies"
    },
    "deployment_security": {
        "name": "Deployment Security & Compliance",
        "description": "Secrets management, access control, and security policies"
    },
    "monitoring_observability": {
        "name": "Monitoring & Observability",
        "description": "Application monitoring, logging, alerting, and dashboards"
    },
    "resilience": {
        "name": "Resilience & Disaster Recovery",
        "description": "Backup strategies, high availability, and disaster recovery"
    }
}


def get_pillar_metadata(category: AssessmentCategory) -> Dict:
    """Get pillar metadata for a specific assessment category"""
    metadata_map = {
        AssessmentCategory.REPOSITORY: REPOSITORY_PILLAR_METADATA,
        AssessmentCategory.CICD: CICD_PILLAR_METADATA,
        AssessmentCategory.DEPLOYMENT: DEPLOYMENT_PILLAR_METADATA,
    }
    return metadata_map.get(category, {})


def get_questions_for_platform(
    category: AssessmentCategory,
    platform: str
) -> Dict[str, Pillar]:
    """
    Get predefined questions for a specific category and platform, organized by pillars
    
    Args:
        category: Assessment category (repository, cicd, deployment)
        platform: The platform name (e.g., 'github', 'github_actions', 'azure')
        
    Returns:
        Dictionary of pillar_id -> Pillar with questions
    """
    # Platform-specific questions mapping
    questions_map = {
        # Repository platforms
        (AssessmentCategory.REPOSITORY, RepositoryPlatform.GITHUB): GITHUB_REPO_QUESTIONS,
        (AssessmentCategory.REPOSITORY, RepositoryPlatform.GITLAB): GITLAB_REPO_QUESTIONS,
        (AssessmentCategory.REPOSITORY, RepositoryPlatform.AZURE_REPOS): AZURE_REPOS_QUESTIONS,
        (AssessmentCategory.REPOSITORY, RepositoryPlatform.BITBUCKET): BITBUCKET_REPO_QUESTIONS,
        # CI/CD platforms
        (AssessmentCategory.CICD, CICDPlatform.GITHUB_ACTIONS): GITHUB_ACTIONS_QUESTIONS,
        (AssessmentCategory.CICD, CICDPlatform.AZURE_PIPELINES): AZURE_PIPELINES_QUESTIONS,
        (AssessmentCategory.CICD, CICDPlatform.GITLAB_CI): GITLAB_CI_QUESTIONS,
        (AssessmentCategory.CICD, CICDPlatform.JENKINS): JENKINS_QUESTIONS,
        (AssessmentCategory.CICD, CICDPlatform.CIRCLECI): CIRCLECI_QUESTIONS,
        # Deployment platforms
        (AssessmentCategory.DEPLOYMENT, DeploymentPlatform.AZURE): AZURE_DEPLOYMENT_QUESTIONS,
        (AssessmentCategory.DEPLOYMENT, DeploymentPlatform.AWS): AWS_DEPLOYMENT_QUESTIONS,
        (AssessmentCategory.DEPLOYMENT, DeploymentPlatform.GCP): GCP_DEPLOYMENT_QUESTIONS,
        (AssessmentCategory.DEPLOYMENT, DeploymentPlatform.ON_PREMISE): ON_PREMISE_DEPLOYMENT_QUESTIONS,
        (AssessmentCategory.DEPLOYMENT, DeploymentPlatform.KUBERNETES): KUBERNETES_DEPLOYMENT_QUESTIONS,
    }
    
    # Convert platform string to enum if needed
    platform_enum = platform
    if isinstance(platform, str):
        if category == AssessmentCategory.REPOSITORY:
            platform_enum = RepositoryPlatform(platform)
        elif category == AssessmentCategory.CICD:
            platform_enum = CICDPlatform(platform)
        elif category == AssessmentCategory.DEPLOYMENT:
            platform_enum = DeploymentPlatform(platform)
    
    platform_questions = questions_map.get((category, platform_enum))
    if not platform_questions:
        raise ValueError(f"No questions found for category={category}, platform={platform}")
    
    # Get pillar metadata for this category
    pillar_metadata = get_pillar_metadata(category)
    
    # Group questions by pillar
    pillar_groups = {}
    for i, (question_text, importance, pillar_category) in enumerate(platform_questions):
        if pillar_category not in pillar_groups:
            pillar_groups[pillar_category] = []
        pillar_groups[pillar_category].append((i, question_text, importance, pillar_category))
    
    # Calculate total importance to distribute 100 points proportionally
    total_importance = sum(importance for _, importance, _ in platform_questions)
    
    # Create pillars with questions
    pillars = {}
    for pillar_id, questions in pillar_groups.items():
        metadata = pillar_metadata[pillar_id]
        
        pillar_questions = [
            Question(
                id=f"{platform}_{category.value}_{i+1}",
                text=question_text,
                max_score=round((importance / total_importance) * 100.0, 2),
                importance=importance,
                pillar=pillar_id,
                category=category.value
            )
            for i, question_text, importance, _ in questions
        ]
        
        # Calculate total weight for this pillar
        pillar_weight = sum(q.max_score for q in pillar_questions)
        
        pillars[pillar_id] = Pillar(
            name=metadata["name"],
            total_weight=round(pillar_weight, 2),
            questions=pillar_questions,
            category=category.value
        )
    
    # Adjust to ensure total is exactly 100 points
    total = sum(pillar.total_weight for pillar in pillars.values())
    if abs(total - 100.0) > 0.01:
        # Adjust the last question of the last pillar
        last_pillar = list(pillars.values())[-1]
        last_question = last_pillar.questions[-1]
        adjustment = 100.0 - total
        last_question.max_score = round(last_question.max_score + adjustment, 2)
        last_pillar.total_weight = round(last_pillar.total_weight + adjustment, 2)
    
    return pillars


# Legacy support for old API
def get_questions_for_tool(tool: RepositoryTool) -> Dict[str, Pillar]:
    """
    Legacy function - maps old RepositoryTool to new structure
    Only returns repository questions
    """
    platform_map = {
        RepositoryTool.GITHUB: RepositoryPlatform.GITHUB,
        RepositoryTool.GITLAB: RepositoryPlatform.GITLAB,
        RepositoryTool.AZURE_DEVOPS: RepositoryPlatform.AZURE_REPOS,
    }
    platform = platform_map.get(tool)
    return get_questions_for_platform(AssessmentCategory.REPOSITORY, platform)


def get_all_questions(pillars: Dict[str, Pillar]) -> List[tuple[str, Question, str]]:
    """Get all questions with their pillar context"""
    questions = []
    for pillar_id, pillar in pillars.items():
        for question in pillar.questions:
            questions.append((pillar_id, question, pillar.name))
    return questions
